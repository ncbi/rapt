{
    "variables": {
        "branch": "",
        "version": "",
        "buildname": ""
    },
    "builders": [
        {
            "type": "googlecompute",
            "instance_name": "rapt-{{user `buildname`}}-packer",
            "image_description": "Image for running RAPT as a fire and forget.",
            "image_name": "rapt-{{user `buildname`}}-{{timestamp}}",
            "account_file": "rapt-gcp-auth.json",
            "project_id": "ncbi-rapt",
            "source_image_family": "centos-8",
            "ssh_username": "rapt",
            "machine_type": "n1-standard-1",
            "disk_size": "200",
            "state_timeout": "20m",
            "zone": "us-east4-c"
        }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "google-fluentd",
            "destination": "/home/rapt/"
        },
        {
            "type": "file",
            "source": "install-pgap.py",
            "destination": "/home/rapt/"
        },
        {
            "type": "shell",
            "environment_vars": [ "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin" ],
            "inline": [
                "sleep 30",
                "set -o verbose",
                "sudo dnf install -y yum-utils device-mapper-persistent-data lvm2",
                "#sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo",
                "sudo dnf config-manager --add-repo=https://download.docker.com/linux/centos/docker-ce.repo",
                "sudo dnf update -y",
                "sudo dnf install -y --nobest python3-devel python3-virtualenv python3-requests docker-ce docker-ce-cli containerd.io tmux gcc nodejs git-core boost boost-devel boost-static zlib-devel",
                "sudo dnf group install -y 'Development Tools'",
                "git clone https://github.com/ncbi/SKESA",
                "cd SKESA && make BOOST_LIB='-L /usr/lib64' && cd $HOME",
                "sudo systemctl disable firewalld",
                "sudo systemctl enable --now docker",
                "sudo ln -sf /usr/share/zoneinfo/America/New_York /etc/localtime",
                "sudo sh -c 'echo -e \"ZONE=/usr/share/zoneinfo/America/New_York\nUTC=true\" > /etc/sysconfig/clock'",
                "echo \"net.ipv4.ip_forward=1\" | sudo tee -a /etc/sysctl.conf > /dev/null",
                "sudo groupadd gpipe",
                "sudo -H pip3 install -U 'cwltool[deps]' cwl-runner",
                "export DO_NOT_INSTALL_CATCH_ALL_CONFIG=1",
                "curl -sSO https://dl.google.com/cloudagents/install-logging-agent.sh",
                "sudo --preserve-env=DO_NOT_INSTALL_CATCH_ALL_CONFIG bash install-logging-agent.sh",
                "rm install-logging-agent.sh",
                "sudo mkdir -p /etc/google-fluentd/config.d",
                "sudo mv /home/rapt/google-fluentd/* /etc/google-fluentd/config.d",
                "rmdir /home/rapt/google-fluentd",
                "sudo chown -R root:root /etc/google-fluentd/config.d",
                "sudo chmod 750 /etc/google-fluentd/config.d",
                "sudo find /etc/google-fluentd/config.d -type f -exec chmod 640 {} +",
                "sudo groupadd gpipe-sudoers",
                "sudo groupadd -f docker",
                "echo '%gpipe-sudoers ALL=(ALL:ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/gpipe_sudoers > /dev/null",
                "sudo usermod -a -G docker,gpipe-sudoers rapt",
                "newgrp docker",
                "mkdir -p /home/rapt/.ssh",
                "echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDFJbfi2jlLC4zlRzKjYx3t3t2Jwm5tdcd41eBR4Z1tVXZK/uj3TxUVluzRmMOnXSd0gFLtIqD7WN4/rzoWjU7Uy6n1IcGxCbk9QDDkw0xqBbwtzL2ZlrOc7xjef0C8M8wIT1ptUk6iWFCovUL/mf6rOEDQsZjayHXhTIVJYrz3jBiIFVJh0flZtt8hgNW/Y01zGdUx0MJhv61B4EPvcGlgiyuxmajJii9tmtnuR10db3SYfGb/v1cGfOID2Q5FVYbl2RrXgitoWNOxdHT6jEaxcM9k2OJLJ7V9moci/3U5ASHYxkBIJFyHTKkSyGMNyxXBv9Ke/HcWJRv8Mz1RrhTf gpipe-dev@ncbi.nlm.nih.gov' > /home/rapt/.ssh/authorized_keys",
                "chmod 600 /home/rapt/.ssh/authorized_keys"
            ]
        },
        {
            "type": "shell",
            "environment_vars": [ "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/sbin" ],
            "inline": [
                "chmod +x install-pgap.py",
                "./install-pgap.py {{user `version`}} {{user `branch`}}",
                "rm install-pgap.py"
            ]
        }
    ]
}

